{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from '@iobroker/adapter-core';\nimport fs from 'fs';\n\nclass NotificationManager extends utils.Adapter {\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({\n            ...options,\n            name: 'notification-manager',\n        });\n        this.on('ready', this.onReady.bind(this));\n        this.on('stateChange', this.onStateChange.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n        this.on('message', this.onMessage.bind(this));\n    }\n\n    /**\n     * Listen to messages from frontend\n     */\n    private async onMessage(obj: ioBroker.Message): Promise<void> {\n        if (obj.command === 'getCategories') {\n            const ioPackPath = require.resolve('iobroker.js-controller/io-package.json');\n\n            const content = await fs.promises.readFile(ioPackPath, {\n                encoding: 'utf-8',\n            });\n\n            const ioPack = JSON.parse(content);\n\n            this.sendTo(obj.from, obj.command, { notifications: ioPack.notifications }, obj.callback);\n            return;\n        }\n\n        if (obj.command === 'getSupportedMessengers') {\n            const res = await this.getObjectViewAsync('system', 'instance', {\n                startkey: 'system.adapter.',\n                endkey: 'system.adapter.\\u9999',\n            });\n\n            const instances = res.rows\n                // @ts-expect-error types are wrong\n                .filter((row) => row.value?.common.type === 'messaging')\n                .map((obj) => obj.id.substring('system.adapter.'.length));\n\n            this.sendTo(obj.from, obj.command, { instances }, obj.callback);\n            return;\n        }\n    }\n\n    /**\n     * Is called when databases are connected and adapter received configuration.\n     */\n    private async onReady(): Promise<void> {\n        this.log.info('Starting notifications manager ...');\n        // TODO: later more generic approach if we have other notifications than system\n        await this.subscribeForeignStates('system.host.*.notifications.system');\n        // TODO perform initial check for notifications on adapter start start\n    }\n\n    /**\n     * Is called when adapter shuts down - callback has to be called under any circumstances!\n     */\n    private onUnload(callback: () => void): void {\n        callback();\n    }\n\n    /**\n     * Is called if a subscribed state changes\n     */\n    private onStateChange(_id: string, _state: ioBroker.State | null | undefined): void {\n        // TODO: the notifications object has changed, check if a new notification has been registered\n        // we need to cache the notifications object up from adapter start to check what is new\n        // or we decide to clear the notifications in every case if we handled them, so that\n        // all notifications which we should handle are new or need a new try\n    }\n}\n\nif (require.main !== module) {\n    // Export the constructor in compact mode\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new NotificationManager(options);\n} else {\n    // otherwise start the instance directly\n    (() => new NotificationManager())();\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AAAA,YAAuB;AACvB,gBAAe;AAEf,MAAM,4BAA4B,MAAM,QAAQ;AAAA,EACrC,YAAY,UAAyC,CAAC,GAAG;AAC5D,UAAM;AAAA,MACF,GAAG;AAAA,MACH,MAAM;AAAA,IACV,CAAC;AACD,SAAK,GAAG,SAAS,KAAK,QAAQ,KAAK,IAAI,CAAC;AACxC,SAAK,GAAG,eAAe,KAAK,cAAc,KAAK,IAAI,CAAC;AACpD,SAAK,GAAG,UAAU,KAAK,SAAS,KAAK,IAAI,CAAC;AAC1C,SAAK,GAAG,WAAW,KAAK,UAAU,KAAK,IAAI,CAAC;AAAA,EAChD;AAAA,EAKA,MAAc,UAAU,KAAsC;AAC1D,QAAI,IAAI,YAAY,iBAAiB;AACjC,YAAM,aAA6B;AAEnC,YAAM,UAAU,MAAM,UAAAA,QAAG,SAAS,SAAS,YAAY;AAAA,QACnD,UAAU;AAAA,MACd,CAAC;AAED,YAAM,SAAS,KAAK,MAAM,OAAO;AAEjC,WAAK,OAAO,IAAI,MAAM,IAAI,SAAS,EAAE,eAAe,OAAO,cAAc,GAAG,IAAI,QAAQ;AACxF;AAAA,IACJ;AAEA,QAAI,IAAI,YAAY,0BAA0B;AAC1C,YAAM,MAAM,MAAM,KAAK,mBAAmB,UAAU,YAAY;AAAA,QAC5D,UAAU;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC;AAED,YAAM,YAAY,IAAI,KAEjB,OAAO,CAAC,QAAK;AAxC9B;AAwCiC,0BAAI,UAAJ,mBAAW,OAAO,UAAS;AAAA,OAAW,EACtD,IAAI,CAACC,SAAQA,KAAI,GAAG,UAAU,kBAAkB,MAAM,CAAC;AAE5D,WAAK,OAAO,IAAI,MAAM,IAAI,SAAS,EAAE,UAAU,GAAG,IAAI,QAAQ;AAC9D;AAAA,IACJ;AAAA,EACJ;AAAA,EAKA,MAAc,UAAyB;AACnC,SAAK,IAAI,KAAK,oCAAoC;AAElD,UAAM,KAAK,uBAAuB,oCAAoC;AAAA,EAE1E;AAAA,EAKQ,SAAS,UAA4B;AACzC,aAAS;AAAA,EACb;AAAA,EAKQ,cAAc,KAAa,QAAiD;AAAA,EAKpF;AACJ;AAEA,IAAI,QAAQ,SAAS,QAAQ;AAEzB,SAAO,UAAU,CAAC,YAAuD,IAAI,oBAAoB,OAAO;AAC5G,OAAO;AAEH,GAAC,MAAM,IAAI,oBAAoB,GAAG;AACtC;",
  "names": ["fs", "obj"]
}
